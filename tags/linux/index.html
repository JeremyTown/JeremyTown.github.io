<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Tag: linux | Jeremy&#39;s Blog</title>
  <meta name="description" content>
  <meta name="keywords" content>
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="Jeremy's Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Jeremy&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/tags/linux/index.html">
<meta property="og:site_name" content="Jeremy&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jeremy&#39;s Blog">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>
</html>
<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/'>
				Jeremy's Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
					<li>
						<a class='flat-box nav-home' href='/'>
							Home
						</a>
					</li>
					
					<li>
						<a class='flat-box nav-archives' href='/archives'>
							Archives
						</a>
					</li>
					
					<li>
						<a class='flat-box nav-gallery' href='https://photos.google.com/album/AF1QipNoqKYgspQo5O1YhlFXGCQ7p575KBH3Yxf8WHL4?hl=zh-CN'>
							Gallery
						</a>
					</li>
					
					<li>
						<a class='flat-box nav-about' href='/about'>
							About
						</a>
					</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
			<div class="m_search">
				<form name="searchform" class="form u-search-form">
					<input type="text" class="input u-search-input" placeholder="Search" />
					<span class="icon icon-search"></span>
				</form>
			</div>
			
			<ul class='switcher h-list'>
				
				<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a>
				</li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span
							class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a>
				</li>
				<li class='s-toc'><a href='javascript:void(0)'><span
							class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
		<a href="/" class="nav-home nav">
			Home
		</a>
		
		<a href="/archives" class="nav-archives nav">
			Archives
		</a>
		
		<a href="https://photos.google.com/album/AF1QipNoqKYgspQo5O1YhlFXGCQ7p575KBH3Yxf8WHL4?hl=zh-CN" class="nav-gallery nav">
			Gallery
		</a>
		
		<a href="/about" class="nav-about nav">
			About
		</a>
		
	</nav>
</aside>
    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        
  <script>
    window.subData= { title:'Tag : linux'}
  </script>

<section class="post-list">
	
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/02/27/promethues/">
        Prometheus + Grafana
      </a>
    </h2>
    
    <time>
      2月 27, 2019
    </time>
		
    
    <div class='cats'>
        <a href="/categories/monitor/">monitor</a>
    </div>

  </section>
  <section class="article typo">
    <!-- 存在摘要时则显示摘要，没有则显示正文 -->
	  <!-- <a id="more"></a>



<h2 id="安装-GO"><a href="#安装-GO" class="headerlink" title="安装 GO"></a>安装 GO</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# yum -y install go</span><br><span class="line">[root@mysqlnode05 go]# go version</span><br></pre></td></tr></table></figure>

<h2 id="安装-prometheus"><a href="#安装-prometheus" class="headerlink" title="安装 prometheus"></a>安装 prometheus</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tar -zxvf prometheus-2.7.1.linux-amd64.tar.gz</span><br><span class="line">[root@master ~]# mv prometheus-2.7.1.linux-amd64 /appdata/prometheus</span><br><span class="line">[root@master ~]# cd /appdata/prometheus/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改prometheus.yml文件，配置targets其中的IP和端口则是对应的exporter的监听端口</span></span><br><span class="line">[root@master ~]# vim prometheus.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span>     <span class="number">15</span><span class="string">s</span> <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">15</span><span class="string">s</span> <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="attr">  alertmanagers:</span></span><br><span class="line"><span class="attr">  - static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span></span><br><span class="line">      <span class="comment"># - alertmanager:9093</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - "first_rules.yml"</span></span><br><span class="line">  <span class="comment"># - "second_rules.yml"</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span> <span class="string">['192.168.41.131:9090']</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'master'</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['192.168.41.131:9100']</span></span><br><span class="line"><span class="attr">        labels:</span></span><br><span class="line"><span class="attr">          instance:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'slave'</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['192.168.41.132:9100']</span></span><br><span class="line"><span class="attr">        labels:</span></span><br><span class="line"><span class="attr">          instance:</span> <span class="string">slave</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'mysql-master'</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['192.168.41.131:9104']</span></span><br><span class="line"><span class="attr">        labels:</span></span><br><span class="line"><span class="attr">          instance:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'mysql-slave'</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['192.168.41.132:9104']</span></span><br><span class="line"><span class="attr">        labels:</span></span><br><span class="line"><span class="attr">          instance:</span> <span class="string">slave</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动并通过web访问</span></span><br><span class="line">[root@master ~]# /appdata/prometheus/prometheus --config.file /appdata/prometheus/prometheus.yml &gt;&gt; /appdata/prometheus/prometheus.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<h2 id="安装-mysqld-exporter"><a href="#安装-mysqld-exporter" class="headerlink" title="安装 mysqld_exporter"></a>安装 mysqld_exporter</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tar -zxvf mysqld_exporter-0.11.0.linux-amd64.tar.gz</span><br><span class="line">[root@master ~]# cp mysqld_exporter-0.11.0.linux-amd64/mysqld_exporter /appdata/prometheus/</span><br><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建专用用户</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create user <span class="string">'prometheus'</span>@<span class="string">'%'</span> identified by <span class="string">'xxxxxx'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> grant REPLICATION CLIENT,PROCESS,SELECT ON *.* TO <span class="string">'prometheus'</span>@<span class="string">'%'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建exporter配置文件</span></span><br><span class="line">[root@master ~]# vim /appdata/prometheus/.my.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">user=mysql_prome</span><br><span class="line">password=Aa123456789</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动mysqld_exporter</span></span><br><span class="line">[root@master ~]# /appdata/prometheus/mysqld_exporter --config.my-cnf /appdata/prometheus/.my.cnf &gt;&gt; /appdata/prometheus/mysqld_exporter.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<h2 id="安装-node-exporter"><a href="#安装-node-exporter" class="headerlink" title="安装 node_exporter"></a>安装 node_exporter</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tar -zxvf node_exporter-0.17.0.linux-amd64.tar.gz</span><br><span class="line">[root@master ~]# cp node_exporter-0.17.0.linux-amd64/node_exporter /appdata/prometheus/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动node_exporter</span></span><br><span class="line">[root@master ~]# /appdata/prometheus/node_exporter &gt;&gt; /appdata/prometheus/node_exporter.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<h2 id="查看-target-status"><a href="#查看-target-status" class="headerlink" title="查看 target status"></a>查看 target status</h2><p>浏览器访问 <a href="http://192.168.31.131:9090" target="_blank" rel="noopener">http://192.168.31.131:9090</a></p>


<h2 id="安装-grafana"><a href="#安装-grafana" class="headerlink" title="安装 grafana"></a>安装 grafana</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# wget https://dl.grafana.com/oss/release/grafana-6.0.0-1.x86_64.rpm </span><br><span class="line">[root@master ~]# yum -y install grafana-6.0.0-1.x86_64.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动grafana</span></span><br><span class="line">[root@master ~]# systemctl enable grafana-server</span><br><span class="line">[root@master ~]# systemctl start grafana-server</span><br></pre></td></tr></table></figure>

<h2 id="添加数据源"><a href="#添加数据源" class="headerlink" title="添加数据源"></a>添加数据源</h2><p>浏览器访问 <a href="http://192.168.31.131:3000" target="_blank" rel="noopener">http://192.168.31.131:3000</a></p>
 -->
    
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/linux/">linux</a>
      
        <a href="/tags/prometheus/">prometheus</a>
      
        <a href="/tags/grafana/">grafana</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/02/07/k8s/">
        Kubernetes 离线安装
      </a>
    </h2>
    
    <time>
      2月 7, 2019
    </time>
		
    
    <div class='cats'>
        <a href="/categories/linux/">linux</a>
    </div>

  </section>
  <section class="article typo">
    <!-- 存在摘要时则显示摘要，没有则显示正文 -->
	  <!-- <a id="more"></a>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/hosts</span><br><span class="line">192.168.61.11 node1</span><br><span class="line">192.168.61.12 node2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line">vim /etc/selinux/config</span><br><span class="line"></span><br><span class="line">SELINUX=disabled</span><br><span class="line"></span><br><span class="line">vim /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>

<h2 id="kube-proxy开启ipvs的前置条件"><a href="#kube-proxy开启ipvs的前置条件" class="headerlink" title="kube-proxy开启ipvs的前置条件"></a>kube-proxy开启ipvs的前置条件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line">EOF</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看是否已经正确加载所需的内核模块</span></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>

<h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"># Step 2: 添加软件源信息</span><br><span class="line">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"># Step 3: 更新并安装 Docker-CE</span><br><span class="line">sudo yum makecache fast</span><br><span class="line"></span><br><span class="line">yum list docker-ce.x86_64  --showduplicates |sort -r</span><br><span class="line"></span><br><span class="line">yum makecache fast</span><br><span class="line"></span><br><span class="line">yum install -y --setopt=obsoletes=0 \</span><br><span class="line">  docker-ce-18.06.1.ce-3.el7</span><br><span class="line"></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -nvL</span><br></pre></td></tr></table></figure>

<h2 id="安装kubeadm和kubelet"><a href="#安装kubeadm和kubelet" class="headerlink" title="安装kubeadm和kubelet"></a>安装kubeadm和kubelet</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum install -y kubelet kubeadm kubectl</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubelet –help</span><br><span class="line"></span><br><span class="line">cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"></span><br><span class="line">vim /etc/sysconfig/kubelet</span><br><span class="line"></span><br><span class="line">KUBELET_EXTRA_ARGS=--fail-swap-on=false</span><br></pre></td></tr></table></figure>

<h2 id="使用kubeadm-init初始化集群"><a href="#使用kubeadm-init初始化集群" class="headerlink" title="使用kubeadm init初始化集群"></a>使用kubeadm init初始化集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">images=(kube-apiserver:v1.13.3 kube-controller-manager:v1.13.3 kube-scheduler:v1.13.3 kube-proxy:v1.13.3 pause:3.1 etcd:3.2.24)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">  docker pull mirrorgooglecontainers/<span class="variable">$imageName</span></span><br><span class="line">  docker tag mirrorgooglecontainers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">  docker rmi mirrorgooglecontainers/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> docker pull coredns/coredns:1.2.6</span><br><span class="line"> docker tag coredns/coredns:1.2.6  k8s.gcr.io/coredns:1.2.6</span><br><span class="line"> docker rmi coredns/coredns:1.2.6</span><br><span class="line"></span><br><span class="line">kubeadm init \</span><br><span class="line">  --kubernetes-version=v1.13.0 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">  --apiserver-advertise-address=192.168.41.132 \</span><br><span class="line">  --ignore-preflight-errors=Swap</span><br><span class="line"><span class="comment"># running with swap on is not supported. Please disable swap</span></span><br><span class="line"><span class="comment"># 添加--ignore-preflight-errors=Swap参数忽略这个错误</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.41.132:6443 --token e4xr2p.xvfc3dr6a4dvz8se --discovery-token-ca-cert-hash sha256:7f99258581c9118551ec500b61bf3d732ed6e31799e5074fc5f75b784633410a</span><br><span class="line"></span><br><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群初始化如果遇到问题，可以使用下面的命令进行清理</span></span><br><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<h2 id="安装Pod-Network"><a href="#安装Pod-Network" class="headerlink" title="安装Pod Network"></a>安装Pod Network</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/k8s/</span><br><span class="line"><span class="built_in">cd</span> ~/k8s</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f  kube-flannel.yml</span><br></pre></td></tr></table></figure>

 -->
    
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/linux/">linux</a>
      
        <a href="/tags/docker/">docker</a>
      
        <a href="/tags/Kubernetes/">Kubernetes</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/01/30/mgr/">
        MySQL 组复制
      </a>
    </h2>
    
    <time>
      1月 30, 2019
    </time>
		
    
    <div class='cats'>
        <a href="/categories/database/">database</a>
    </div>

  </section>
  <section class="article typo">
    <!-- 存在摘要时则显示摘要，没有则显示正文 -->
	  <!-- <a id="more"></a>

<h2 id="1-部署组复制实例"><a href="#1-部署组复制实例" class="headerlink" title="1. 部署组复制实例"></a>1. 部署组复制实例</h2><p>假定MySQL Server已下载并解压缩到名为的目录中mysql-8.0。以下过程使用一台物理计算机，因此每个MySQL服务器实例都需要该实例的特定数据目录。在名为的目录中创建数据目录data 并初始化每个目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir data</span><br><span class="line">mysql-8.0/bin/mysqld --initialize-insecure --basedir=$PWD/mysql-8.0 --datadir=$PWD/data/s1</span><br><span class="line">mysql-8.0/bin/mysqld --initialize-insecure --basedir=$PWD/mysql-8.0 --datadir=$PWD/data/s2</span><br><span class="line">mysql-8.0/bin/mysqld --initialize-insecure --basedir=$PWD/mysql-8.0 --datadir=$PWD/data/s3</span><br></pre></td></tr></table></figure>

<p>里面data/s1，data/s2， data/s3是一个初始化的数据目录，包含了MySQL系统数据库和相关表等等</p>
<blockquote>
<p>–initialize-insecure在生产环境中使用，它仅用于简化教程。</p>
</blockquote>
<h2 id="2-配置组复制实例"><a href="#2-配置组复制实例" class="headerlink" title="2. 配置组复制实例"></a>2. 配置组复制实例</h2><h3 id="组Replication-Server设置"><a href="#组Replication-Server设置" class="headerlink" title="组Replication Server设置"></a>组Replication Server设置</h3><p>要安装和使用组复制插件，必须正确配置MySQL Server实例。建议将配置存储在实例的配置文件中。以下是组中第一个实例的配置，在此过程中称为s1。以下部分显示了示例服务器配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"># server configuration</span><br><span class="line">datadir=&lt;full_path_to_data&gt;/data/s1</span><br><span class="line">basedir=&lt;full_path_to_bin&gt;/mysql-8.0/</span><br><span class="line"></span><br><span class="line">port=24801</span><br><span class="line">socket=&lt;full_path_to_sock_dir&gt;/s1.sock</span><br></pre></td></tr></table></figure>

<p>这些设置将MySQL服务器配置为使用先前创建的数据目录以及服务器应打开的端口并开始侦听传入连接。</p>
<blockquote>
<p>使用非默认端口24801是因为在本教程中，三个服务器实例使用相同的主机名。在具有三台不同机器的设置中，这不是必需的。</p>
</blockquote>
<p>组复制需要成员之间的网络连接，这意味着每个成员必须能够解析所有其他成员的网络地址。例如，在本教程中，所有三个实例都在一台机器上运行，因此为了确保成员可以相互联系，您可以在选项文件中添加一行，例如 report_host=127.0.0.1。</p>
<h3 id="复制框架"><a href="#复制框架" class="headerlink" title="复制框架"></a>复制框架</h3><p>以下设置根据MySQL组复制要求配置复制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server_id=1</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">binlog_checksum=NONE</span><br></pre></td></tr></table></figure>

<p>这些设置将服务器配置为使用唯一标识符编号1，以启用全局事务标识符，以允许仅执行可使用GTID安全记录的语句，以及禁用写入写入二进制日志的事件的校验和。</p>
<blockquote>
<p>如果您使用的是早于8.0.3的MySQL版本，其中默认值已针对复制进行了改进，则需要将这些行添加到成员的选项文件中。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log_bin=binlog</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">binlog_format=ROW</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br></pre></td></tr></table></figure>

<p>这些设置指示服务器打开二进制日志记录，使用基于行的格式，将复制元数据存储在系统表而不是文件中，并禁用二进制日志事件校验和。有关更多详细信息，请参见 第18.8.1节“组复制要求”。</p>
<h3 id="组复制设置"><a href="#组复制设置" class="headerlink" title="组复制设置"></a>组复制设置</h3><p>此时，该my.cnf文件确保配置服务器并指示在给定配置下实例化复制基础结构。以下部分配置服务器的“组复制”设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">group_replication_start_on_boot=off</span><br><span class="line">group_replication_local_address= &quot;127.0.0.1:24901&quot;</span><br><span class="line">group_replication_group_seeds= &quot;127.0.0.1:24901,127.0.0.1:24902,127.0.0.1:24903&quot;</span><br><span class="line">group_replication_bootstrap_group=off</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 transaction_write_set_extraction 指示服务器对于每个事务，它必须收集写集并使用XXHASH64散列算法将其编码为散列。从MySQL 8.0.2开始，此设置是默认设置，因此可以省略此行。</li>
<li>配置 group_replication_group_name 告诉插件它正在加入或创建的组被命名为”aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa”，group_replication_group_name的值 必须是有效的UUID。在二进制日志中为组复制事件设置GTID时，将在内部使用此UUID。使用SELECT UUID()生成一个UUID。</li>
<li>配置 group_replication_start_on_boot 指示插件在服务器启动时不自动启动操作。这在设置组复制时很重要，因为它确保您可以在手动启动插件之前配置服务器。配置成员后，您可以设置 group_replication_start_on_boot 为on，以便在服务器引导时自动启动Group Replication。</li>
<li>配置 group_replication_local_address 告诉插件使用网络地址127.0.0.1和端口24901与组中的其他成员进行内部通信。</li>
</ul>
<blockquote>
<p>组复制将此地址用于涉及组通信引擎（XCom，Paxos变体）的远程实例的内部成员到成员连接。此地址必须与用于SQL的主机名和端口不同，并且不得用于客户端应用程序。在运行组复制时，必须为组成员之间的内部通信保留它。</p>
</blockquote>
<p>配置的网络地址 group_replication_local_address 必须可由所有组成员解析。例如，如果每个服务器实例位于具有固定网络地址的其他计算机上，则可以使用计算机的IP地址，例如10.0.0.1。如果使用主机名，则必须使用完全限定名称，并确保它可以通过DNS解析，并且配置正确 /etc/hosts文件或其他名称解析过程。从MySQL 8.0.14开始，可以使用IPv6地址（或解析它们的主机名）以及IPv4地址。组可以包含使用IPv6的成员和使用IPv4的成员的混合。</p>
<p>建议的端口 group_replication_local_address 是33061。在本教程中，我们使用在一台计算机上运行的三个服务器实例，因此端口24901到24903用于内部通信网络地址。 group_replication_local_address Group Replication使用它作为复制组中组成员的唯一标识符。只要主机名或IP地址都不同，您就可以为复制组的所有成员使用相同的端口，并且如本教程所示，只要具有相同的主机名或IP地址，就可以使用相同的主机名或IP地址。港口都不一样。</p>
<ul>
<li>配置 group_replication_group_seeds 设置组成员的主机名和端口，新成员使用它们建立与组的连接。这些成员称为种子成员。建立连接后，将列出组成员身份信息 performance_schema.replication_group_members。通常， group_replication_group_seeds 列表包含hostname:port每个组成员的列表 group_replication_local_address，但这不是强制性的，可以选择组成员的子集作为种子。</li>
</ul>
<blockquote>
<p>该hostname:port列在 group_replication_group_seeds 是种子构件的内部网络地址，由被配置 group_replication_local_address ，而不是SQL hostname:port用于客户端连接，并且例如在显示 performance_schema.replication_group_members 表中。</p>
</blockquote>
<p>启动该组的服务器不使用此选项，因为它是初始服务器，因此，它负责引导组。换句话说，引导该组的服务器上的任何现有数据都是用作下一个加入成员的数据。第二个服务器连接要求组中唯一的成员加入，第二个服务器上的任何缺失数据都从引导成员上的施主数据中复制，然后组扩展。加入的第三个服务器可以要求这两个服务器中的任何一个加入，数据被同步到新成员，然后该组再次扩展。</p>
<blockquote>
<p>在同时加入多个服务器时，请确保它们指向已在该组中的种子成员。不要使用也加入该组的成员作为种子，因为他们在联系时可能尚未加入该组。</p>
</blockquote>
<p>最好首先启动引导程序成员，然后让它创建组。然后使其成为正在加入的其余成员的种子成员。这确保了在连接其余成员时形成的组。</p>
<p>不支持创建组并同时加入多个成员。它可能有效，但可能是操作竞争，然后加入该组的行为最终会出错或超时。</p>
<p>加入成员必须使用种子成员在group_replication_group_seeds 选项中通告的相同协议（IPv4或IPv6）与种子成员通信 。出于组复制的IP地址白名单的目的，种子成员上的白名单必须包含种子成员提供的协议的加入成员的IP地址，或者解析为该协议的地址的主机名。除了加入成员之外，还必须设置此地址或主机名并列入白名单 group_replication_local_address 如果该地址的协议与种子成员的通告协议不匹配。如果加入成员没有适当协议的白名单地址，则拒绝其连接尝试。有关更多信息，请参见 第18.5.1节“IP地址白名单”。</p>
<ul>
<li>配置 group_replication_bootstrap_group 指示插件是否引导组。</li>
</ul>
<blockquote>
<p>此选项只能在任何时候在一个服务器实例上使用，通常是第一次引导组时（或者在整个组关闭并重新备份的情况下）。如果多次引导组，例如当多个服务器实例设置了此选项时，则可以创建一个人工分裂脑情景，其中存在两个具有相同名称的不同组。在第一个服务器实例联机后禁用此选项。组中所有服务器的配置非常相似。您需要更改有关每个服务器的细节（例如server_id， datadir， group_replication_local_address）。本教程稍后将对此进行说明。</p>
</blockquote>
<h2 id="3-用户凭证"><a href="#3-用户凭证" class="headerlink" title="3. 用户凭证"></a>3. 用户凭证</h2><p>组复制使用异步复制协议来实现 分布式恢复过程依赖于名为的复制通道group_replication_recovery，该通道用于将来自供体成员的事务转移到加入该组的成员。因此，您需要设置具有正确权限的复制用户，以便组复制可以建立直接的成员到成员恢复复制通道。</p>
<p>使用选项文件启动服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql-8.0/bin/mysqld --defaults-file=data/s1/s1.cnf</span><br></pre></td></tr></table></figure>

<p>使用该REPLICATION-SLAVE权限创建MySQL用户 。可以在二进制日志中捕获此过程，然后您可以依靠分布式恢复来复制用于创建用户的语句。或者，您可以禁用二进制日志记录，然后在每个成员上手动创建用户，例如，如果要避免将更改传播到其他服务器实例。要禁用二进制日志记录，请连接到服务器s1并发出以下语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET SQL_LOG_BIN=0;</span><br></pre></td></tr></table></figure>

<p>在以下示例中rpl_user，将password显示具有密码 的用户 。配置服务器时，请使用合适的用户名和密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE USER rpl_user@&apos;%&apos; IDENTIFIED BY &apos;password&apos;;</span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO rpl_user@&apos;%&apos;;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>如果禁用了二进制日志记录，则在创建用户后再次启用它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET SQL_LOG_BIN=1;</span><br></pre></td></tr></table></figure>

<p>配置用户后，使用该 CHANGE MASTER TO语句将服务器配置为group_replication_recovery在下次需要从另一个成员恢复其状态时使用复制通道的给定凭据 。发出以下，替换 rpl_user和 password与创建用户时使用的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO MASTER_USER=&apos;rpl_user&apos;, MASTER_PASSWORD=&apos;password&apos; \\</span><br><span class="line">		      FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br></pre></td></tr></table></figure>

<p>分布式恢复是加入组的服务器采取的第一步，并且没有与组成员相同的事务集。如果没有为group_replication_recovery 复制通道正确设置这些凭据，并且rpl_user如图所示，则服务器无法连接到供体成员并运行分布式恢复过程以与其他组成员同步，因此最终无法加入该组。</p>
<p>同样，如果服务器无法通过服务器正确识别其他成员，hostname则恢复过程可能会失败。建议运行MySQL的操作系统具有正确配置的唯一 hostname，使用DNS或本地设置。这hostname可以Member_host在performance_schema.replication_group_members 表格的列中 进行验证 。如果多个组成员外部化hostname操作系统的默认 设置，则成员可能无法解析为正确的成员地址而无法加入该组。在这种情况下，使用report_host配置hostname由每个服务器外部化的唯一。</p>
<h3 id="使用组复制和缓存SHA-2用户凭据插件"><a href="#使用组复制和缓存SHA-2用户凭据插件" class="headerlink" title="使用组复制和缓存SHA-2用户凭据插件"></a>使用组复制和缓存SHA-2用户凭据插件</h3><p>默认情况下，在MySQL 8中创建的用户使用 缓存SHA-2可插入身份验证。如果rpl_user您配置分布式恢复使用缓存SHA-2认证插件并没有使用安全套接字层支持（SSL） 的group_replication_recovery 复制通道，RSA密钥用于密码交换，创建SSL和RSA证书和密钥，您可以将rpl_user应该从组中恢复其状态的成员的公钥复制 到该组，也可以将捐赠者配置为在请求时提供公钥。</p>
<p>更安全的方法是将公钥复制 rpl_user到应该从捐赠者恢复组状态的成员。然后，您需要group_replication_recovery_public_key_path 在加入组的成员上配置 系统变量，并为其提供公钥的路径rpl_user。</p>
<p>可选地，不太安全的方法是设置 group_replication_recovery_get_public_key=ON 捐赠者，以便他们rpl_user在加入组时提供成员的公钥 。无法验证服务器的身份，因此只有group_replication_recovery_get_public_key=ON 在您确定没有服务器身份被泄露的风险时才会设置 ，例如通过中间人攻击。</p>
<h2 id="4-启动组复制"><a href="#4-启动组复制" class="headerlink" title="4. 启动组复制"></a>4. 启动组复制</h2><p>配置并启动服务器s1后，安装组复制插件。连接到服务器并发出以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>mysql.session在加载组复制之前，用户必须存在。 MySQL 8.0.2版中添加了mysql.session。如果使用早期版本初始化数据字典，则必须运行 mysql_upgrade过程。如果未运行升级，则组复制无法以错误消息启动尝试使用用户访问服务器时出现错误：mysql.session@localhost。确保用户在服务器中，并且在服务器更新后运行了mysql_upgrade。</p>
</blockquote>
<p>要检查插件是否已成功安装，请发出 SHOW PLUGINS;并检查输出。它应该显示如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW PLUGINS;</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+-------------+</span><br><span class="line">| Name                       | Status   | Type               | Library              | License     |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+-------------+</span><br><span class="line">| binlog                     | ACTIVE   | STORAGE ENGINE     | NULL                 | PROPRIETARY |</span><br><span class="line"></span><br><span class="line">(...)</span><br><span class="line"></span><br><span class="line">| group_replication          | ACTIVE   | GROUP REPLICATION  | group_replication.so | PROPRIETARY |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+-------------+</span><br></pre></td></tr></table></figure>

<p>要启动该组，请指示服务器s1引导该组，然后启动组复制。此引导程序应仅由单个服务器完成，该服务器启动组并且只执行一次。这就是为什么bootstrap配置选项的值未保存在配置文件中的原因。如果它保存在配置文件中，则在重新启动时，服务器会自动引导具有相同名称的第二个组。这将导致两个具有相同名称的不同组。同样的推理适用于在此选项设置为的情况下停止并重新启动插件ON。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL group_replication_bootstrap_group=ON;</span><br><span class="line">START GROUP_REPLICATION;</span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=OFF;</span><br></pre></td></tr></table></figure>

<p>一旦START GROUP_REPLICATION 语句返回，该集团已启动。您可以检查该组现在是否已创建，并且其中包含一个成员：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE  |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br><span class="line">| group_replication_applier | ce9be252-2b71-11e6-b8f4-00212844f856 | myhost      |       24801 | ONLINE        |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br></pre></td></tr></table></figure>

<p>此表中的信息确认组中有成员具有唯一标识符 ce9be252-2b71-11e6-b8f4-00212844f856，它正在ONLINE并且正在myhost 侦听端口上的客户端连接 24801。</p>
<p>为了证明服务器确实在一个组中并且它能够处理负载，创建一个表并向其添加一些内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE test;</span><br><span class="line">mysql&gt; USE test;</span><br><span class="line">mysql&gt; CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL);</span><br><span class="line">mysql&gt; INSERT INTO t1 VALUES (1, &apos;Luis&apos;);</span><br></pre></td></tr></table></figure>

<p>检查表的内容t1和二进制日志。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM t1;</span><br><span class="line">+----+------+</span><br><span class="line">| c1 | c2   |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | Luis |</span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW BINLOG EVENTS;</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos | Event_type     | Server_id | End_log_pos | Info                                                               |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| binlog.000001 |   4 | Format_desc    |         1 |         123 | Server ver: 8.0.2-gr080-log, Binlog ver: 4                        |</span><br><span class="line">| binlog.000001 | 123 | Previous_gtids |         1 |         150 |                                                                    |</span><br><span class="line">| binlog.000001 | 150 | Gtid           |         1 |         211 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1&apos;  |</span><br><span class="line">| binlog.000001 | 211 | Query          |         1 |         270 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 | 270 | View_change    |         1 |         369 | view_id=14724817264259180:1                                        |</span><br><span class="line">| binlog.000001 | 369 | Query          |         1 |         434 | COMMIT                                                             |</span><br><span class="line">| binlog.000001 | 434 | Gtid           |         1 |         495 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:2&apos;  |</span><br><span class="line">| binlog.000001 | 495 | Query          |         1 |         585 | CREATE DATABASE test                                               |</span><br><span class="line">| binlog.000001 | 585 | Gtid           |         1 |         646 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:3&apos;  |</span><br><span class="line">| binlog.000001 | 646 | Query          |         1 |         770 | use `test`; CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL) |</span><br><span class="line">| binlog.000001 | 770 | Gtid           |         1 |         831 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4&apos;  |</span><br><span class="line">| binlog.000001 | 831 | Query          |         1 |         899 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 | 899 | Table_map      |         1 |         942 | table_id: 108 (test.t1)                                            |</span><br><span class="line">| binlog.000001 | 942 | Write_rows     |         1 |         984 | table_id: 108 flags: STMT_END_F                                    |</span><br><span class="line">| binlog.000001 | 984 | Xid            |         1 |        1011 | COMMIT /* xid=38 */                                                |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>如上所示，创建了数据库和表对象，并将相应的DDL语句写入二进制日志。此外，数据已插入表中并写入二进制日志。当组成长并且新成员尝试赶上并联机时执行分布式恢复时，下一节将说明二进制日志条目的重要性。</p>
<h2 id="5-向组添加实例"><a href="#5-向组添加实例" class="headerlink" title="5. 向组添加实例"></a>5. 向组添加实例</h2><p>此时，该组中有一个成员服务器s1，其中包含一些数据。现在是时候通过添加先前配置的其他两个服务器来扩展组。</p>
<h3 id="添加第二个实例"><a href="#添加第二个实例" class="headerlink" title="添加第二个实例"></a>添加第二个实例</h3><p>为了添加第二个实例，服务器s2，首先为它创建配置文件。配置类似于用于服务器s1的配置，除了诸如数据目录的位置，s2将要监听的端口或其之外的配置 server_id。这些不同的行在下面的列表中突出显示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"># server configuration</span><br><span class="line">datadir=&lt;full_path_to_data&gt;/data/s2</span><br><span class="line">basedir=&lt;full_path_to_bin&gt;/mysql-8.0/</span><br><span class="line"></span><br><span class="line">port=24802</span><br><span class="line">socket=&lt;full_path_to_sock_dir&gt;/s2.sock</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Replication configuration parameters</span><br><span class="line">#</span><br><span class="line">server_id=2</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Group Replication configuration</span><br><span class="line">#</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">group_replication_start_on_boot=off</span><br><span class="line">group_replication_local_address= &quot;127.0.0.1:24902&quot;</span><br><span class="line">group_replication_group_seeds= &quot;127.0.0.1:24901,127.0.0.1:24902,127.0.0.1:24903&quot;</span><br><span class="line">group_replication_bootstrap_group= off</span><br></pre></td></tr></table></figure>

<p>与服务器s1的过程类似，使用选项文件启动服务器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql-8.0/bin/mysqld --defaults-file=data/s2/s2.cnf</span><br></pre></td></tr></table></figure>

<p>然后按如下方式配置恢复凭据。这些命令与设置服务器s1时使用的命令相同，因为用户在组内共享。在s2上发布以下语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SET SQL_LOG_BIN=0;</span><br><span class="line">CREATE USER rpl_user@&apos;%&apos; IDENTIFIED BY &apos;password&apos;;</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO rpl_user@&apos;%&apos;;</span><br><span class="line">SET SQL_LOG_BIN=1;</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&apos;rpl_user&apos;, MASTER_PASSWORD=&apos;password&apos; \\</span><br><span class="line">	FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果您使用的是缓存SHA-2身份验证插件（MySQL 8中的默认设置），请参阅 使用组复制和缓存SHA-2用户凭据插件。</p>
</blockquote>
<p>安装组复制插件并开始将服务器加入组的过程。以下示例以与部署服务器s1时相同的方式安装插件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br></pre></td></tr></table></figure>

<p>将服务器s2添加到组中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure>

<p>与之前的步骤（与s1上执行的步骤相同）不同，此处的区别在于， 在启动组复制之前不会发出SET GLOBAL group_replication_bootstrap_group=ON;，因为该组已由服务器s1创建并引导。此时，只需将服务器s2添加到现有组中。</p>
<blockquote>
<p>当组复制成功启动并且服务器加入组时，它会检查 super_read_only变量。通过super_read_only 在成员的配置文件中设置为ON，可以确保因任何原因启动组复制时出现故障的服务器不接受事务。如果服务器应将该组作为读写实例加入，例如作为单主组中的主要组或多主组的成员，则当该 super_read_only变量设置为ON时，则在加入时将其设置为OFF群组。</p>
</blockquote>
<p>performance_schema.replication_group_members 再次 检查 表显示该组中现在有两个 ONLINE服务器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE  |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br><span class="line">| group_replication_applier | 395409e1-6dfa-11e6-970b-00212844f856 | myhost      |       24801 | ONLINE        |</span><br><span class="line">| group_replication_applier | ac39f1e6-6dfa-11e6-a69d-00212844f856 | myhost      |       24802 | ONLINE        |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br></pre></td></tr></table></figure>

<p>由于服务器s2也标记为ONLINE，它必须已经自动赶上服务器s1。验证它确实已与服务器s1同步，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW DATABASES LIKE &apos;test&apos;;</span><br><span class="line">+-----------------+</span><br><span class="line">| Database (test) |</span><br><span class="line">+-----------------+</span><br><span class="line">| test            |</span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM test.t1;</span><br><span class="line">+----+------+</span><br><span class="line">| c1 | c2   |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | Luis |</span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW BINLOG EVENTS;</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos  | Event_type     | Server_id | End_log_pos | Info                                                               |</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| binlog.000001 |    4 | Format_desc    |         2 |         123 | Server ver: 8.0.3-log, Binlog ver: 4                              |</span><br><span class="line">| binlog.000001 |  123 | Previous_gtids |         2 |         150 |                                                                    |</span><br><span class="line">| binlog.000001 |  150 | Gtid           |         1 |         211 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1&apos;  |</span><br><span class="line">| binlog.000001 |  211 | Query          |         1 |         270 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 |  270 | View_change    |         1 |         369 | view_id=14724832985483517:1                                        |</span><br><span class="line">| binlog.000001 |  369 | Query          |         1 |         434 | COMMIT                                                             |</span><br><span class="line">| binlog.000001 |  434 | Gtid           |         1 |         495 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:2&apos;  |</span><br><span class="line">| binlog.000001 |  495 | Query          |         1 |         585 | CREATE DATABASE test                                               |</span><br><span class="line">| binlog.000001 |  585 | Gtid           |         1 |         646 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:3&apos;  |</span><br><span class="line">| binlog.000001 |  646 | Query          |         1 |         770 | use `test`; CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL) |</span><br><span class="line">| binlog.000001 |  770 | Gtid           |         1 |         831 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4&apos;  |</span><br><span class="line">| binlog.000001 |  831 | Query          |         1 |         890 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 |  890 | Table_map      |         1 |         933 | table_id: 108 (test.t1)                                            |</span><br><span class="line">| binlog.000001 |  933 | Write_rows     |         1 |         975 | table_id: 108 flags: STMT_END_F                                    |</span><br><span class="line">| binlog.000001 |  975 | Xid            |         1 |        1002 | COMMIT /* xid=30 */                                                |</span><br><span class="line">| binlog.000001 | 1002 | Gtid           |         1 |        1063 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:5&apos;  |</span><br><span class="line">| binlog.000001 | 1063 | Query          |         1 |        1122 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 | 1122 | View_change    |         1 |        1261 | view_id=14724832985483517:2                                        |</span><br><span class="line">| binlog.000001 | 1261 | Query          |         1 |        1326 | COMMIT                                                             |</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>如上所示，第二台服务器已添加到组中，并自动从服务器s1复制了更改。根据分布式恢复过程，这意味着在加入组之后并且在被声明在线之前，服务器s2已经自动连接到服务器s1并从中获取丢失的数据。换句话说，它将事务从缺少的s1的二进制日志复制到它加入组的时间点。</p>
<h3 id="添加其他实例"><a href="#添加其他实例" class="headerlink" title="添加其他实例"></a>添加其他实例</h3><p>向组添加其他实例与添加第二个服务器的步骤顺序基本相同，只是必须更改配置，因为必须更改服务器s2。总结所需的命令：</p>
<ol>
<li>创建配置文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"># server configuration</span><br><span class="line">datadir=&lt;full_path_to_data&gt;/data/s3</span><br><span class="line">basedir=&lt;full_path_to_bin&gt;/mysql-8.0/</span><br><span class="line"></span><br><span class="line">port=24803</span><br><span class="line">socket=&lt;full_path_to_sock_dir&gt;/s3.sock</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Replication configuration parameters</span><br><span class="line">#</span><br><span class="line">server_id=3</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Group Replication configuration</span><br><span class="line">#</span><br><span class="line">group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">group_replication_start_on_boot=off</span><br><span class="line">group_replication_local_address= &quot;127.0.0.1:24903&quot;</span><br><span class="line">group_replication_group_seeds= &quot;127.0.0.1:24901,127.0.0.1:24902,127.0.0.1:24903&quot;</span><br><span class="line">group_replication_bootstrap_group= off</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动服务器</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql-8.0/bin/mysqld --defaults-file=data/s3/s3.cnf</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置group_replication_recovery通道的恢复凭据。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SET SQL_LOG_BIN=0;</span><br><span class="line">CREATE USER rpl_user@&apos;%&apos; IDENTIFIED BY &apos;password&apos;;</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO rpl_user@&apos;%&apos;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">SET SQL_LOG_BIN=1;</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&apos;rpl_user&apos;, MASTER_PASSWORD=&apos;password&apos;  \\</span><br><span class="line">FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>安装Group Replication插件并启动它。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br><span class="line">START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure>

<p>此时，服务器s3已启动并正在运行，已加入该组并赶上该组中的其他服务器。performance_schema.replication_group_members 再次咨询 表证实了这种情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE  |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br><span class="line">| group_replication_applier | 395409e1-6dfa-11e6-970b-00212844f856 | myhost      |       24801 | ONLINE        |</span><br><span class="line">| group_replication_applier | 7eb217ff-6df3-11e6-966c-00212844f856 | myhost      |       24803 | ONLINE        |</span><br><span class="line">| group_replication_applier | ac39f1e6-6dfa-11e6-a69d-00212844f856 | myhost      |       24802 | ONLINE        |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+---------------+</span><br></pre></td></tr></table></figure>

<p>在服务器s2或服务器s1上发出相同的查询会产生相同的结果。此外，您可以验证服务器s3是否也赶上了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW DATABASES LIKE &apos;test&apos;;</span><br><span class="line">+-----------------+</span><br><span class="line">| Database (test) |</span><br><span class="line">+-----------------+</span><br><span class="line">| test            |</span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM test.t1;</span><br><span class="line">+----+------+</span><br><span class="line">| c1 | c2   |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | Luis |</span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW BINLOG EVENTS;</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos  | Event_type     | Server_id | End_log_pos | Info                                                               |</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br><span class="line">| binlog.000001 |    4 | Format_desc    |         3 |         123 | Server ver: 8.0.3-log, Binlog ver: 4                              |</span><br><span class="line">| binlog.000001 |  123 | Previous_gtids |         3 |         150 |                                                                    |</span><br><span class="line">| binlog.000001 |  150 | Gtid           |         1 |         211 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1&apos;  |</span><br><span class="line">| binlog.000001 |  211 | Query          |         1 |         270 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 |  270 | View_change    |         1 |         369 | view_id=14724832985483517:1                                        |</span><br><span class="line">| binlog.000001 |  369 | Query          |         1 |         434 | COMMIT                                                             |</span><br><span class="line">| binlog.000001 |  434 | Gtid           |         1 |         495 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:2&apos;  |</span><br><span class="line">| binlog.000001 |  495 | Query          |         1 |         585 | CREATE DATABASE test                                               |</span><br><span class="line">| binlog.000001 |  585 | Gtid           |         1 |         646 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:3&apos;  |</span><br><span class="line">| binlog.000001 |  646 | Query          |         1 |         770 | use `test`; CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL) |</span><br><span class="line">| binlog.000001 |  770 | Gtid           |         1 |         831 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4&apos;  |</span><br><span class="line">| binlog.000001 |  831 | Query          |         1 |         890 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 |  890 | Table_map      |         1 |         933 | table_id: 108 (test.t1)                                            |</span><br><span class="line">| binlog.000001 |  933 | Write_rows     |         1 |         975 | table_id: 108 flags: STMT_END_F                                    |</span><br><span class="line">| binlog.000001 |  975 | Xid            |         1 |        1002 | COMMIT /* xid=29 */                                                |</span><br><span class="line">| binlog.000001 | 1002 | Gtid           |         1 |        1063 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:5&apos;  |</span><br><span class="line">| binlog.000001 | 1063 | Query          |         1 |        1122 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 | 1122 | View_change    |         1 |        1261 | view_id=14724832985483517:2                                        |</span><br><span class="line">| binlog.000001 | 1261 | Query          |         1 |        1326 | COMMIT                                                             |</span><br><span class="line">| binlog.000001 | 1326 | Gtid           |         1 |        1387 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:6&apos;  |</span><br><span class="line">| binlog.000001 | 1387 | Query          |         1 |        1446 | BEGIN                                                              |</span><br><span class="line">| binlog.000001 | 1446 | View_change    |         1 |        1585 | view_id=14724832985483517:3                                        |</span><br><span class="line">| binlog.000001 | 1585 | Query          |         1 |        1650 | COMMIT                                                             |</span><br><span class="line">+---------------+------+----------------+-----------+-------------+--------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

 -->
    
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/linux/">linux</a>
      
        <a href="/tags/mysql/">mysql</a>
      
        <a href="/tags/mgr/">mgr</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/01/29/powerline/">
        使用 Powerline 美化终端
      </a>
    </h2>
    
    <time>
      1月 29, 2019
    </time>
		
    
    <div class='cats'>
        <a href="/categories/tools/">tools</a>
    </div>

  </section>
  <section class="article typo">
    <!-- 存在摘要时则显示摘要，没有则显示正文 -->
	  <!-- <a id="more"></a>

<h2 id="安装-python3"><a href="#安装-python3" class="headerlink" title="安装 python3"></a>安装 python3</h2><p>Ubuntu</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]<span class="comment"># sudo apt install python3 python3-pip</span></span><br></pre></td></tr></table></figure>

<h2 id="安装-powerline"><a href="#安装-powerline" class="headerlink" title="安装 powerline"></a>安装 powerline</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]# python3 -m pip install powerline-status</span><br><span class="line">[root@ubuntu ~]# python3 -m pip show powerline-status</span><br><span class="line">Name: powerline-status</span><br><span class="line">Version: 2.7</span><br><span class="line">Summary: The ultimate statusline/prompt utility.</span><br><span class="line">Home-page: https://github.com/powerline/powerline</span><br><span class="line">Author: Kim Silkebaekken</span><br><span class="line">Author-email: kim.silkebaekken+vim@gmail.com</span><br><span class="line">License: MIT</span><br><span class="line">Location: /usr/local/lib/python3.6/dist-packages</span><br><span class="line">Requires:</span><br></pre></td></tr></table></figure>

<h2 id="设置-bash"><a href="#设置-bash" class="headerlink" title="设置 bash"></a>设置 bash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]<span class="comment"># vim ~/.bashrc</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powerline-daemon -q</span><br><span class="line">POWERLINE_BASH_CONTINUATION=1</span><br><span class="line">POWERLINE_BASH_SELECT=1</span><br><span class="line">. /usr/local/lib/python3.6/dist-packages/powerline/bindings/bash/powerline.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>效果图

</li>
</ul>
<h2 id="设置-vim"><a href="#设置-vim" class="headerlink" title="设置 vim"></a>设置 vim</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]<span class="comment"># vim ~/.vimrc</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set rtp+=/usr/local/lib/python3.6/dist-packages/powerline/bindings/vim/</span><br><span class="line">set laststatus=2</span><br><span class="line">set t_Co=256</span><br></pre></td></tr></table></figure>

<ul>
<li>效果图

</li>
</ul>
 -->
    
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/linux/">linux</a>
      
        <a href="/tags/powerline/">powerline</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/01/07/uwsgi/">
        uWSGI 部署 Django 应用
      </a>
    </h2>
    
    <time>
      1月 7, 2019
    </time>
		
    
    <div class='cats'>
        <a href="/categories/linux/">linux</a>
    </div>

  </section>
  <section class="article typo">
    <!-- 存在摘要时则显示摘要，没有则显示正文 -->
	  <!-- <a id="more"></a>

<ul>
<li>demo项目的目录结构</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">demo/</span><br><span class="line">├── db.sqlite3</span><br><span class="line">├── demo</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── __pycache__</span><br><span class="line">│   │   ├── __init__.cpython-36.pyc</span><br><span class="line">│   │   ├── settings.cpython-36.pyc</span><br><span class="line">│   │   ├── urls.cpython-36.pyc</span><br><span class="line">│   │   └── wsgi.cpython-36.pyc</span><br><span class="line">│   ├── settings.py</span><br><span class="line">│   ├── urls.py</span><br><span class="line">│   └── wsgi.py</span><br><span class="line">├── manage.py</span><br><span class="line">└── requirements.txt</span><br></pre></td></tr></table></figure>

<h2 id="安装相关工具和依赖"><a href="#安装相关工具和依赖" class="headerlink" title="安装相关工具和依赖"></a>安装相关工具和依赖</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@uwsgi ~]<span class="comment"># yum -y install git wget httpd vim # 安装相关工具</span></span><br><span class="line">[root@uwsgi ~]<span class="comment"># yum -y install gcc zlib* openssl-devel # 安装编译工具和依赖库</span></span><br></pre></td></tr></table></figure>

<h2 id="安装-Python-环境"><a href="#安装-Python-环境" class="headerlink" title="安装 Python 环境"></a>安装 Python 环境</h2><p>rhel系列无法通过yum直接安装python3，需要源码编译安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@uwsgi ~]<span class="comment"># pwd # 查看当前目录</span></span><br><span class="line">/root</span><br><span class="line">[root@uwsgi ~]<span class="comment"># wget https://www.python.org/ftp/python/3.6.5/Python-3.6.5.tgz # 下载python3.6.5</span></span><br><span class="line">[root@uwsgi ~]<span class="comment"># tar -zxvf Python-3.6.5.tgz # 解压</span></span><br><span class="line">[root@uwsgi ~]<span class="comment"># cd Python-3.6.5</span></span><br><span class="line"></span><br><span class="line">[root@uwsgi Python-3.6.5]<span class="comment"># pwd # 查看当前目录</span></span><br><span class="line">/root/Python-3.6.5</span><br><span class="line">[root@uwsgi Python-3.6.5]<span class="comment"># ./configure # 编译</span></span><br><span class="line">[root@uwsgi Python-3.6.5]<span class="comment"># make &amp;&amp; make install # 安装</span></span><br><span class="line">[root@uwsgi Python-3.6.5]<span class="comment"># which python3 # 查看python3的路径</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/python3</span><br></pre></td></tr></table></figure>

<h2 id="安装-uWSGI"><a href="#安装-uWSGI" class="headerlink" title="安装 uWSGI"></a>安装 uWSGI</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@uwsgi ~]<span class="comment"># python3 -m pip install uwsgi</span></span><br></pre></td></tr></table></figure>

<h2 id="安装配置虚拟环境"><a href="#安装配置虚拟环境" class="headerlink" title="安装配置虚拟环境"></a>安装配置虚拟环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@uwsgi ~]<span class="comment"># python3 -m pip install virtualenv # 安装虚拟环境</span></span><br><span class="line">[root@uwsgi ~]<span class="comment"># virtualenv -p /usr/local/bin/python3 /venv # 配置虚拟环境</span></span><br><span class="line">[root@uwsgi ~]<span class="comment"># source /venv/bin/activate # 激活虚拟环境</span></span><br><span class="line">(venv) [root@uwsgi ~]<span class="comment"># pip install -r /root/demo/requirements.txt # 安装项目依赖</span></span><br><span class="line">(venv) [root@uwsgi ~]<span class="comment"># pip freeze # 查看依赖库是否安装</span></span><br><span class="line">(venv) [root@uwsgi ~]<span class="comment"># deactivate # 取消激活虚拟环境</span></span><br><span class="line">[root@uwsgi ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="修改-ALLOW-HOSTS"><a href="#修改-ALLOW-HOSTS" class="headerlink" title="修改 ALLOW_HOSTS"></a>修改 ALLOW_HOSTS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@uwsgi ~]<span class="comment"># vim demo/demo/settings.py # 编辑项目中的 settings.py</span></span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_HOSTS = [<span class="string">"192.168.41.130"</span>,]</span><br></pre></td></tr></table></figure>

<h2 id="配置-uWSGI"><a href="#配置-uWSGI" class="headerlink" title="配置 uWSGI"></a>配置 uWSGI</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@uwsgi ~]<span class="comment"># mkdir -p /var/log/uwsgi # 创建 uwsgi 的日志目录</span></span><br><span class="line">[root@uwsgi ~]<span class="comment"># vim /etc/uwsgi.ini # 创建 uwsgi.ini 配置文件</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">chdir=/root/demo</span><br><span class="line">http=192.168.41.130:8000</span><br><span class="line">home=/venv</span><br><span class="line">module=demo.wsgi:application</span><br><span class="line">master=True</span><br><span class="line">pidfile=/tmp/demo.pid</span><br><span class="line">max-requests=5000</span><br><span class="line">daemonize=/var/log/uwsgi/demo.log</span><br><span class="line">env=LANG=en_US.UTF-8</span><br><span class="line">buffer-size=32768</span><br></pre></td></tr></table></figure>

<h2 id="启动-uWSGI"><a href="#启动-uWSGI" class="headerlink" title="启动 uWSGI"></a>启动 uWSGI</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@uwsgi ~]<span class="comment"># uwsgi --init /etc/uwsgi.ini # 以 /etc/uwsgi.ini 配置启动 uwsgi</span></span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><table>
<thead>
<tr>
<th>路径</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>/root/demo</td>
<td>项目路径</td>
</tr>
<tr>
<td>/usr/local/bin/python3</td>
<td>python3默认安装路径</td>
</tr>
<tr>
<td>/etc/uwsgi.ini</td>
<td>uwsgi配置文件</td>
</tr>
<tr>
<td>/var/log/uwsgi/demo.log</td>
<td>uwsgi日志文件</td>
</tr>
<tr>
<td>/venv</td>
<td>python虚拟环境路径</td>
</tr>
</tbody></table>
<p>未安装zlib*：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zipimport.ZipImportError: can&apos;t decompress data; zlib not available # 编译时报错</span><br></pre></td></tr></table></figure>

<p>未安装openssl、openssl-devel：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available # pip 安装 uwsgi 时报错</span><br></pre></td></tr></table></figure>

<p>uwsgi 无法访问，日志报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invalid request block size: 21573 (max 4096)...skip # 在 /etc/uwsgi.ini 中添加 buffer-size=32768</span><br></pre></td></tr></table></figure> -->
    
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/linux/">linux</a>
      
        <a href="/tags/python/">python</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/01/04/jenkins/">
        jenkins 入门指南
      </a>
    </h2>
    
    <time>
      1月 4, 2019
    </time>
		
    
    <div class='cats'>
        <a href="/categories/linux/">linux</a>
    </div>

  </section>
  <section class="article typo">
    <!-- 存在摘要时则显示摘要，没有则显示正文 -->
	  <!-- <a id="more"></a>

<p>sudo wget -O /etc/yum.repos.d/jenkins.repo <a href="https://pkg.jenkins.io/redhat-stable/jenkins.repo" target="_blank" rel="noopener">https://pkg.jenkins.io/redhat-stable/jenkins.repo</a><br>sudo rpm –import <a href="https://pkg.jenkins.io/redhat-stable/jenkins.io.key" target="_blank" rel="noopener">https://pkg.jenkins.io/redhat-stable/jenkins.io.key</a></p>
<p>yum install jenkins</p>
 -->
    
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/linux/">linux</a>
      
        <a href="/tags/jenkins/">jenkins</a>
      
        <a href="/tags/ci/">ci</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2019/01/03/gitlab/">
        gitlab-ce 入坑指南
      </a>
    </h2>
    
    <time>
      1月 3, 2019
    </time>
		
    
    <div class='cats'>
        <a href="/categories/linux/">linux</a>
    </div>

  </section>
  <section class="article typo">
    <!-- 存在摘要时则显示摘要，没有则显示正文 -->
	  <!-- <a id="more"></a>

<h2 id="更新软件包"><a href="#更新软件包" class="headerlink" title="更新软件包"></a>更新软件包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure>

<h2 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a>配置防火墙</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># vim /etc/sysctl.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure>

<ul>
<li>启用并启动防火墙</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># systemctl enable firewalld</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># systemctl start firewalld</span></span><br></pre></td></tr></table></figure>

<ul>
<li>放通 HTTP、HTTPS</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># firewall-cmd --add-service=http --permanent</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># firewall-cmd --add-service=https --permanent</span></span><br></pre></td></tr></table></figure>

<ul>
<li>重载入防火墙</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># systemctl reload firewalld</span></span><br></pre></td></tr></table></figure>

<h2 id="安装-postfix"><a href="#安装-postfix" class="headerlink" title="安装 postfix"></a>安装 postfix</h2><p>GitLab 需要使用 postfix 来发送邮件。当然，也可以使用 SMTP 服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># vim /etc/postfix/main.cf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># inet_protocols = all</span><br><span class="line">inet_protocols = ipv4</span><br></pre></td></tr></table></figure>

<ul>
<li>启用并启动 postfix</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># systemctl restart postfix</span></span><br></pre></td></tr></table></figure>

<h2 id="配置-swap"><a href="#配置-swap" class="headerlink" title="配置 swap"></a>配置 swap</h2><p>由于 GitLab 较为消耗资源，我们需要先创建交换分区，以降低物理内存的压力。<br>在实际生产环境中，如果服务器配置够高，则不必配置交换分区。</p>
<ul>
<li>新建 2 GB 大小的交换分区</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># dd if=/dev/zero of=/root/swapfile bs=1M count=2048</span></span><br></pre></td></tr></table></figure>

<ul>
<li>格式化为交换分区文件并启用</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># mkswap /root/swapfile</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># swapon /root/swapfile</span></span><br></pre></td></tr></table></figure>

<ul>
<li>添加自启用</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># vim /etc/fstab</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/swapfile swap swap defaults 0 0</span><br></pre></td></tr></table></figure>

<h2 id="安装-GitLab"><a href="#安装-GitLab" class="headerlink" title="安装 GitLab"></a>安装 GitLab</h2><ul>
<li>将软件源修改为国内源</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># vim /etc/yum.repos.d/gitlab-ce.repo</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[gitlab-ce]</span><br><span class="line">name=Gitlab CE Repository</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure>

<ul>
<li>安装 GitLab</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># yum makecache</span></span><br><span class="line">[root@gitlab ~]<span class="comment"># yum install -y gitlab-ce</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">     *.                  *.</span><br><span class="line">    ***                 ***</span><br><span class="line">   *****               *****</span><br><span class="line">  .******             *******</span><br><span class="line">  ********            ********</span><br><span class="line"> ,,,,,,,,,***********,,,,,,,,,</span><br><span class="line">,,,,,,,,,,,*********,,,,,,,,,,,</span><br><span class="line">.,,,,,,,,,,,*******,,,,,,,,,,,,</span><br><span class="line">    ,,,,,,,,,*****,,,,,,,,,.</span><br><span class="line">       ,,,,,,,****,,,,,,</span><br><span class="line">          .,,,***,,,,</span><br><span class="line">              ,*,.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   _______ __  __          __</span><br><span class="line">  / ____(_) /_/ /   ____ _/ /_</span><br><span class="line"> / / __/ / __/ /   / __ `/ __ \</span><br><span class="line">/ /_/ / / /_/ /___/ /_/ / /_/ /</span><br><span class="line">\____/_/\__/_____/\__,_/_.___/</span><br><span class="line"></span><br><span class="line">Thank you for installing GitLab!</span><br></pre></td></tr></table></figure>

<h2 id="配置-HTTPS-证书"><a href="#配置-HTTPS-证书" class="headerlink" title="配置 HTTPS 证书"></a>配置 HTTPS 证书</h2><ul>
<li>生成 key 文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># openssl genrsa -out "/etc/gitlab/ssl/gitlab.example.com.key"</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">.........................................................................................................+++</span><br><span class="line">..............................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>

<ul>
<li>生成 csr 文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ssl]<span class="comment"># openssl req -new -key "/etc/gitlab/ssl/gitlab.example.com.key" -out "/etc/gitlab/ssl/gitlab.example.com.csr"</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:sz</span><br><span class="line">Locality Name (eg, city) [Default City]:sz</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:example</span><br><span class="line">Organizational Unit Name (eg, section) []:</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:gitlab.example.com</span><br><span class="line">Email Address []:admin@example.com</span><br><span class="line"></span><br><span class="line">Please enter the following &apos;extra&apos; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:password</span><br><span class="line">An optional company name []:</span><br></pre></td></tr></table></figure>

<ul>
<li>生成 crt 文件 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># openssl x509 -req -days 365 -in "/etc/gitlab/ssl/gitlab.example.com.csr" -signkey "/etc/gitlab/ssl/gitlab.example.com.key" -out "/etc/gitlab/ssl/gitlab.example.com.crt"</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Signature ok</span><br><span class="line">subject=/C=cn/ST=sz/L=sz/O=example/CN=gitlab.example.com/emailAddress=admin@example.com</span><br><span class="line">Getting Private key</span><br></pre></td></tr></table></figure>

<ul>
<li>生成 dhparams.pem</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ssl]<span class="comment"># openssl dhparam -out /etc/gitlab/ssl/dhparams.pem 2048</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化-GitLab"><a href="#初始化-GitLab" class="headerlink" title="初始化 GitLab"></a>初始化 GitLab</h2><ul>
<li>配置 GitLab</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># vim /etc/gitlab/gitlab.rb</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">external_url &apos;http://gitlab.example.com&apos;</span><br><span class="line">nginx[&apos;redirect_http_to_https&apos;] = true</span><br><span class="line">nginx[&apos;ssl_certificate&apos;] = &quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span><br><span class="line">nginx[&apos;ssl_certificate_key&apos;] = &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;</span><br><span class="line">nginx[&apos;ssl_dhparam&apos;] = &quot;/etc/gitlab/ssl/dhparams.pem&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化 GitLab</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改 nginx 配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># vim /var/opt/gitlab/nginx/conf/gitlab-http.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen *:80;</span><br><span class="line"></span><br><span class="line">  rewrite ^(.*)$ https://$host$1 permanent; # 新增</span><br><span class="line"></span><br><span class="line">  server_name gitlab.example.com;</span><br><span class="line">  server_tokens off; ## Don&apos;t show the nginx version number, a security best practice</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    return 301 https://gitlab.example.com:443$request_uri;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  access_log  /var/log/gitlab/nginx/gitlab_access.log gitlab_access;</span><br><span class="line">  error_log   /var/log/gitlab/nginx/gitlab_error.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重启 gitlab</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]<span class="comment"># gitlab-ctl restart</span></span><br></pre></td></tr></table></figure>

 -->
    
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/linux/">linux</a>
      
        <a href="/tags/gitlab/">gitlab</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
    <div class='post-wrapper'>
      <article class="post reveal">
  <section class="meta">
    
    <h2 class="title">
      <a href="/2018/12/18/ambari/">
        使用 Ambari 部署 Hadoop 集群
      </a>
    </h2>
    
    <time>
      12月 18, 2018
    </time>
		
    
    <div class='cats'>
        <a href="/categories/linux/">linux</a>
    </div>

  </section>
  <section class="article typo">
    <!-- 存在摘要时则显示摘要，没有则显示正文 -->
	  <!-- <a id="more"></a>

<h2 id="配置本地yum源"><a href="#配置本地yum源" class="headerlink" title="配置本地yum源"></a>配置本地yum源</h2><h3 id="安装httpd"><a href="#安装httpd" class="headerlink" title="安装httpd"></a>安装httpd</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd -y</span><br></pre></td></tr></table></figure>

<h3 id="在官方下载镜像文件"><a href="#在官方下载镜像文件" class="headerlink" title="在官方下载镜像文件"></a>在官方下载镜像文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.6.1.0/ambari.repo</span><br><span class="line">wget http://public-repo-1.hortonworks.com/HDP/centos7/2.x/updates/2.6.4.0/hdp.repo</span><br><span class="line">wget http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.6.1.0/ambari-2.6.1.0-centos7.tar.gz</span><br><span class="line">wget http://public-repo-1.hortonworks.com/HDP-UTILS-1.1.0.22/repos/centos7/HDP-UTILS-1.1.0.22-centos7.tar.gz</span><br><span class="line">wget http://public-repo-1.hortonworks.com/HDP-GPL/centos7/2.x/updates/2.6.4.0/HDP-GPL-2.6.4.0-centos7-rpm.tar.gz</span><br><span class="line">wget http://public-repo-1.hortonworks.com/HDP/centos7/2.x/updates/2.6.4.0/HDP-2.6.4.0-centos7-rpm.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="将对应的tar包解压到httpd的文件目录"><a href="#将对应的tar包解压到httpd的文件目录" class="headerlink" title="将对应的tar包解压到httpd的文件目录"></a>将对应的tar包解压到httpd的文件目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /var/www/html</span><br><span class="line">tar -zxvf ambari-2.6.1.0-centos7.tar.gz</span><br><span class="line">tar -zxvf HDP-2.6.4.0-centos7-rpm.tar.gz </span><br><span class="line">tar -zxvf HDP-GPL-2.6.4.0-centos7-rpm.tar.gz </span><br><span class="line">tar -zxvf HDP-UTILS-1.1.0.22-centos7.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="配置基础源，创建hadoop的repo文件"><a href="#配置基础源，创建hadoop的repo文件" class="headerlink" title="配置基础源，创建hadoop的repo文件"></a>配置基础源，创建hadoop的repo文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ambari 源</span></span><br><span class="line">vim /etc/yum.repo.d/ambari.repo</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[ambari-2.6.1.0]</span><br><span class="line">name=ambari Version - ambari-2.6.1.0</span><br><span class="line">baseurl=http://192.168.10.11/ambari/centos7/2.6.1.0-143</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://192.168.10.11/ambari/centos7/2.6.1.0-143/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins</span><br><span class="line">enabled=1</span><br><span class="line">priority=1</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> hadoop源</span></span><br><span class="line">vim /etc/yum.repo.d/hdp.repo</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#VERSION_NUMBER=2.6.4.0-91</span><br><span class="line">[HDP-2.6.4.0]</span><br><span class="line">name=HDP Version - HDP-2.6.4.0</span><br><span class="line">baseurl=http://192.168.10.11/HDP/centos7/2.6.4.0-91</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://192.168.10.11/HDP/centos7/2.6.4.0-91/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins</span><br><span class="line">enabled=1</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[HDP-UTILS-1.1.0.22]</span><br><span class="line">name=HDP-UTILS Version - HDP-UTILS-1.1.0.22</span><br><span class="line">baseurl=http://192.168.10.11/HDP-UTILS/centos7/1.1.0.22/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://192.168.10.11/HDP-UTILS/centos7/1.1.0.22/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins</span><br><span class="line">enabled=1</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[HDP-GPL-2.6.4.0]</span><br><span class="line">name=HDP-GPL Version - HDP-GPL-2.6.4.0</span><br><span class="line">baseurl=http://192.168.10.11/HDP-GPL/centos7/2.6.4.0-91</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://192.168.10.11/HDP-GPL/centos7/2.6.4.0-91/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins</span><br><span class="line">enabled=1</span><br><span class="line">priority=1</span><br></pre></td></tr></table></figure>

<h3 id="启动httpd"><a href="#启动httpd" class="headerlink" title="启动httpd"></a>启动httpd</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable httpd</span><br><span class="line">systemctl start httpd</span><br></pre></td></tr></table></figure>

<h3 id="将本地源的repo配置拷贝到其它节点，并创建缓存"><a href="#将本地源的repo配置拷贝到其它节点，并创建缓存" class="headerlink" title="将本地源的repo配置拷贝到其它节点，并创建缓存"></a>将本地源的repo配置拷贝到其它节点，并创建缓存</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/yum.repos.d/ambari.repo 192.168.135.4:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/ambari.repo 192.168.135.5:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/hdp.repo 192.168.135.6:/etc/yum.repos.d/</span><br></pre></td></tr></table></figure>

<p>在各个节点创建缓存：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure>

<h2 id="初始化环境"><a href="#初始化环境" class="headerlink" title="初始化环境"></a>初始化环境</h2><h3 id="各个节点安装java-1-8-0-openjdk"><a href="#各个节点安装java-1-8-0-openjdk" class="headerlink" title="各个节点安装java-1.8.0-openjdk"></a>各个节点安装java-1.8.0-openjdk</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk -y</span><br></pre></td></tr></table></figure>

<h3 id="解析主机名"><a href="#解析主机名" class="headerlink" title="解析主机名"></a>解析主机名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo "192.168.135.4 node2" &gt;&gt; /etc/hosts</span><br><span class="line">echo "192.168.135.5 node3" &gt;&gt; /etc/hosts</span><br><span class="line">echo "192.168.135.6 node4" &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<h3 id="创建主机信任关系"><a href="#创建主机信任关系" class="headerlink" title="创建主机信任关系"></a>创建主机信任关系</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id node-1</span><br><span class="line">ssh-copy-id node-2</span><br><span class="line">ssh-copy-id node-3</span><br></pre></td></tr></table></figure>

<h3 id="安装配置数据库"><a href="#安装配置数据库" class="headerlink" title="安装配置数据库"></a>安装配置数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install mariadb-server -y</span><br><span class="line">systemctl enable mariadb</span><br><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure>

<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">password</span>=<span class="keyword">password</span>(<span class="string">'123456'</span>);</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> root@localhost <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> root@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> ambari <span class="keyword">default</span> <span class="built_in">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> ambari.* <span class="keyword">to</span> ambari@localhost <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'bigdata'</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> ambari.* <span class="keyword">to</span> ambari@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'bigdata'</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> hive <span class="keyword">default</span> <span class="built_in">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> hive.* <span class="keyword">to</span> hive@localhost <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'hive'</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> hive.* <span class="keyword">to</span> hive@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'hive'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="安装Amabri服务"><a href="#安装Amabri服务" class="headerlink" title="安装Amabri服务"></a>安装Amabri服务</h2><h3 id="在node-1上安装ambari-server-并启动配置向导"><a href="#在node-1上安装ambari-server-并启动配置向导" class="headerlink" title="在node-1上安装ambari-server,并启动配置向导"></a>在node-1上安装ambari-server,并启动配置向导</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install ambari-server -y</span><br><span class="line">ambari-server setup</span><br></pre></td></tr></table></figure>

<h3 id="按照配置向导信息、配置用户、java-home"><a href="#按照配置向导信息、配置用户、java-home" class="headerlink" title="按照配置向导信息、配置用户、java_home"></a>按照配置向导信息、配置用户、java_home</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ambari-server setup</span><br><span class="line">Using python  /usr/bin/python</span><br><span class="line">Setup ambari-server</span><br><span class="line">Checking SELinux...</span><br><span class="line">SELinux status is 'disabled'</span><br><span class="line">Customize user account for ambari-server daemon [y/n] (n)? y</span><br><span class="line">Enter user account for ambari-server daemon (root):ambari  </span><br><span class="line">Adjusting ambari-server permissions and ownership...</span><br><span class="line">Checking firewall status...</span><br><span class="line">Checking JDK...</span><br><span class="line">[1] Oracle JDK 1.8 + Java Cryptography Extension (JCE) Policy Files 8</span><br><span class="line">[2] Oracle JDK 1.7 + Java Cryptography Extension (JCE) Policy Files 7</span><br><span class="line">[3] Custom JDK</span><br><span class="line">==============================================================================</span><br><span class="line">Enter choice (1): 3</span><br><span class="line">WARNING: JDK must be installed on all hosts and JAVA_HOME must be valid on all hosts.</span><br><span class="line">WARNING: JCE Policy files are required for configuring Kerberos security. If you plan to use Kerberos,please make sure JCE Unlimited Strength Jurisdiction Policy Files are valid on all hosts.</span><br><span class="line">Path to JAVA_HOME: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre  # 填写java_home</span><br><span class="line">Validating JDK on Ambari Server...done.</span><br><span class="line">Checking GPL software agreement...</span><br><span class="line">GPL License for LZO: https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html</span><br><span class="line">Enable Ambari Server to download and install GPL Licensed LZO packages [y/n] (n)? n</span><br><span class="line">Completing setup...</span><br><span class="line">Configuring database...</span><br><span class="line">Enter advanced database configuration [y/n] (n)? y  </span><br><span class="line">Configuring database...</span><br><span class="line">==============================================================================</span><br><span class="line">Choose one of the following options:</span><br><span class="line">[1] - PostgreSQL (Embedded)</span><br><span class="line">[2] - Oracle</span><br><span class="line">[3] - MySQL / MariaDB</span><br><span class="line">[4] - PostgreSQL</span><br><span class="line">[5] - Microsoft SQL Server (Tech Preview)</span><br><span class="line">[6] - SQL Anywhere</span><br><span class="line">[7] - BDB</span><br><span class="line">==============================================================================</span><br><span class="line">Enter choice (1): 3</span><br><span class="line">Hostname (localhost): </span><br><span class="line">Port (3306): </span><br><span class="line">Database name (ambari): </span><br><span class="line">Username (ambari): </span><br><span class="line">Enter Database Password (bigdata): </span><br><span class="line">Configuring ambari database...</span><br><span class="line">WARNING: Before starting Ambari Server, you must copy the MySQL JDBC driver JAR file to /usr/share/java and set property "server.jdbc.driver.path=[path/to/custom_jdbc_driver]" in ambari.properties.</span><br><span class="line">Press &lt;enter&gt; to continue.</span><br></pre></td></tr></table></figure>

<h3 id="到上面一步时，根据提示上传mysql的jdbc驱动，并修改配置文件，指定jdbc驱动文件位置："><a href="#到上面一步时，根据提示上传mysql的jdbc驱动，并修改配置文件，指定jdbc驱动文件位置：" class="headerlink" title="到上面一步时，根据提示上传mysql的jdbc驱动，并修改配置文件，指定jdbc驱动文件位置："></a>到上面一步时，根据提示上传mysql的jdbc驱动，并修改配置文件，指定jdbc驱动文件位置：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/java</span><br><span class="line">ll</span><br><span class="line">tar xf mysql-connector-java-5.1.45.tar.gz </span><br><span class="line">mv mysql-connector-java-5.1.45/mysql-connector-java-5.1.45-bin.jar ./</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置文件：</span></span><br><span class="line">vim /etc/ambari-server/conf/ambari.properties</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.jdbc.driver.path=/usr/share/java/mysql-connector-java-5.1.45-bin.jar</span><br></pre></td></tr></table></figure>

<p>配置完成后继续，会出现如下提示：</p>
<p>Press <enter> to continue.<br>Configuring remote database connection properties…<br>WARNING: Before starting Ambari Server, you must run the following DDL against the database to create the schema: /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql<br>Proceed with configuring remote database connection properties [y/n] (y)? </enter></p>
<h3 id="出现上述提示时，根据信息导入数据库"><a href="#出现上述提示时，根据信息导入数据库" class="headerlink" title="出现上述提示时，根据信息导入数据库"></a>出现上述提示时，根据信息导入数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p ambari &lt; /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql</span><br></pre></td></tr></table></figure>

<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ambari-server start</span><br></pre></td></tr></table></figure> -->
    
    
    
    
	  <div class="full-width auto-padding tags">
      
        <a href="/tags/linux/">linux</a>
      
        <a href="/tags/ambari/">ambari</a>
      
        <a href="/tags/hadoop/">hadoop</a>
      
	  </div>
    
  </section>
</article>
    </div>
  
</section>


  <nav id="page-nav">
    
    
    <a class="next" rel="next" href="/tags/linux/page/2/">
      <span class="text">Next</span>
      <span class="icon icon-chevron-right"></span>
    </a>
    
  </nav>
  

      </div>
      <aside class='l_side'>
        
  <section class='m_widget links'>
    <div class='header'>Links</div>
    <div class='content'>
        <ul class="entry">
            
            <li><a class="flat-box" target="_blank" href="https://github.com/JeremyTown/">
                    <div class='name'>Github</div>
                </a></li>
            
        </ul>
    </div>
</section>

  <section class='m_widget recents'>
    <div class='header'>Recents</div>
    <div class='content'>
        
        <ul class="entry">
            
            <li><a class="flat-box" href="/2019/05/26/git/">
                    <div class='name'>Git 指南</div>
                </a></li>
            
            <li><a class="flat-box" href="/2019/02/27/promethues/">
                    <div class='name'>Prometheus + Grafana</div>
                </a></li>
            
            <li><a class="flat-box" href="/2019/02/18/mysql/">
                    <div class='name'>MySQL 安装指南</div>
                </a></li>
            
            <li><a class="flat-box" href="/2019/02/07/k8s/">
                    <div class='name'>Kubernetes 离线安装</div>
                </a></li>
            
            <li><a class="flat-box" href="/2019/01/30/mgr/">
                    <div class='name'>MySQL 组复制</div>
                </a></li>
            
        </ul>
        
    </div>
</section>

  <section class='m_widget categories'>
    <div class='header'>Categories</div>
    <div class='content'>
        
        <ul class="entry">
            
            <li><a class="flat-box" href="/categories/database/">
                    <div class='name'>database</div>
                    <div class='badget'>4</div>
                </a></li>
            
            <li><a class="flat-box" href="/categories/linux/">
                    <div class='name'>linux</div>
                    <div class='badget'>25</div>
                </a></li>
            
            <li><a class="flat-box" href="/categories/monitor/">
                    <div class='name'>monitor</div>
                    <div class='badget'>6</div>
                </a></li>
            
            <li><a class="flat-box" href="/categories/shell/">
                    <div class='name'>shell</div>
                    <div class='badget'>1</div>
                </a></li>
            
            <li><a class="flat-box" href="/categories/tools/">
                    <div class='name'>tools</div>
                    <div class='badget'>7</div>
                </a></li>
            
        </ul>
        
    </div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/Kubernetes/" style="font-size: 14px; color: #808080">Kubernetes</a> <a href="/tags/ambari/" style="font-size: 14px; color: #808080">ambari</a> <a href="/tags/ansible/" style="font-size: 14px; color: #808080">ansible</a> <a href="/tags/archlinux/" style="font-size: 14px; color: #808080">archlinux</a> <a href="/tags/blog/" style="font-size: 15.5px; color: #606060">blog</a> <a href="/tags/ci/" style="font-size: 14px; color: #808080">ci</a> <a href="/tags/docker/" style="font-size: 15.5px; color: #606060">docker</a> <a href="/tags/ftp/" style="font-size: 14px; color: #808080">ftp</a> <a href="/tags/git/" style="font-size: 14px; color: #808080">git</a> <a href="/tags/gitlab/" style="font-size: 14px; color: #808080">gitlab</a> <a href="/tags/grafana/" style="font-size: 14px; color: #808080">grafana</a> <a href="/tags/hadoop/" style="font-size: 15.5px; color: #606060">hadoop</a> <a href="/tags/hexo/" style="font-size: 14px; color: #808080">hexo</a> <a href="/tags/jekyll/" style="font-size: 14px; color: #808080">jekyll</a> <a href="/tags/jenkins/" style="font-size: 14px; color: #808080">jenkins</a> <a href="/tags/keepalive/" style="font-size: 14px; color: #808080">keepalive</a> <a href="/tags/linux/" style="font-size: 20px; color: #000">linux</a> <a href="/tags/lvs/" style="font-size: 14px; color: #808080">lvs</a> <a href="/tags/mgr/" style="font-size: 14px; color: #808080">mgr</a> <a href="/tags/mysql/" style="font-size: 17px; color: #404040">mysql</a> <a href="/tags/network/" style="font-size: 17px; color: #404040">network</a> <a href="/tags/nginx/" style="font-size: 14px; color: #808080">nginx</a> <a href="/tags/nodejs/" style="font-size: 15.5px; color: #606060">nodejs</a> <a href="/tags/oracle/" style="font-size: 14px; color: #808080">oracle</a> <a href="/tags/powerline/" style="font-size: 14px; color: #808080">powerline</a> <a href="/tags/powershell/" style="font-size: 14px; color: #808080">powershell</a> <a href="/tags/prometheus/" style="font-size: 14px; color: #808080">prometheus</a> <a href="/tags/python/" style="font-size: 17px; color: #404040">python</a> <a href="/tags/raspberrypi/" style="font-size: 14px; color: #808080">raspberrypi</a> <a href="/tags/replication/" style="font-size: 14px; color: #808080">replication</a> <a href="/tags/ruby/" style="font-size: 14px; color: #808080">ruby</a> <a href="/tags/selinux/" style="font-size: 14px; color: #808080">selinux</a> <a href="/tags/shell/" style="font-size: 17px; color: #404040">shell</a> <a href="/tags/svn/" style="font-size: 14px; color: #808080">svn</a> <a href="/tags/tomcat/" style="font-size: 15.5px; color: #606060">tomcat</a> <a href="/tags/ubuntu/" style="font-size: 14px; color: #808080">ubuntu</a> <a href="/tags/vim/" style="font-size: 14px; color: #808080">vim</a> <a href="/tags/virtualbox/" style="font-size: 14px; color: #808080">virtualbox</a> <a href="/tags/windows/" style="font-size: 15.5px; color: #606060">windows</a> <a href="/tags/wsl/" style="font-size: 14px; color: #808080">wsl</a> <a href="/tags/zabbix/" style="font-size: 18.5px; color: #202020">zabbix</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Powered by <a href='https://hexo.io/zh-cn/' class="codename">Hexo</a></div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
